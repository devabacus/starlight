# .github/workflows/deploy.yml
name: Astro CD Pipeline to K8s

on:
  push:
    branches:
      - master # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # --- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 2. –°–±–æ—Ä–∫–∞ Astro –∏ Docker ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build Astro Static Files
        run: npm run build # –°–æ–∑–¥–∞–µ—Ç –ø–∞–ø–∫—É dist/

      # --- 3. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Timeweb Registry –∏ —Å–±–æ—Ä–∫–∞ Docker ---
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: 12cbd00d-reasonable-corvus.registry.twcstorage.ru # üî¥ –í–ê–® –ê–î–†–ï–° –†–ï–ï–°–¢–†–ê
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: 12cbd00d-reasonable-corvus.registry.twcstorage.ru/astro-starlight:latest # üî¥ –í–ê–® –ü–û–õ–ù–´–ô –ü–£–¢–¨ –ö –û–ë–†–ê–ó–£

      # --- 4. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Kubernetes (GitOps) ---
      - name: Set up Kubeconfig
        # –°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª kubeconfig –∏–∑ —Å–µ–∫—Ä–µ—Ç–∞
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" > ~/.kube/config
          
      - name: Check Kubeconfig and Context
        run: kubectl config get-contexts

      - name: Apply K8s Manifests
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –≤–∞—à–∏ YAML-—Ñ–∞–π–ª—ã (Deployment, Service, Ingress)
        run: kubectl apply -f astro-manifests.yaml 

      - name: Trigger K8s Deployment Restart
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ–º K8s —Å–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ —Å —Ç–µ–≥–æ–º :latest
        run: kubectl rollout restart deployment astro-starlight-deployment # üî¥ –í–ê–®–ï –ò–ú–Ø DEPLOYMENT

      - name: Clean up Kubeconfig
        run: rm ~/.kube/config